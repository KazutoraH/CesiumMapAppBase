FROM python:3.10-slim-bookworm

# å¿…è¦ãªãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆGDAL 3.xï¼‰
RUN apt-get update && apt-get install -y \
    lsb-release \
    curl \
    build-essential \
    cmake \
    gcc \
    g++ \
    git \
    make \
    libgeos-dev \
    libproj-dev \
    libspatialindex-dev \
    libboost-all-dev \
    gdal-bin \
    libgdal-dev \
    libglib2.0-0 && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# GDALã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
RUN gdalinfo --version

# libgdal ã®å ´æ‰€ã‚’ç¢ºèªï¼ˆä»»æ„ï¼‰
RUN echo "Searching for libgdal..." && find / -name "libgdal.so*" || true

# GDAL ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚’ä½¿ã†ãŸã‚ã®ç’°å¢ƒå¤‰æ•°
ENV CPLUS_INCLUDE_PATH=/usr/include/gdal
ENV C_INCLUDE_PATH=/usr/include/gdal

# ğŸ”§ libgdal ã®å…±æœ‰ãƒ©ã‚¤ãƒ–ãƒ©ãƒªãƒ‘ã‚¹ã‚’ LD_LIBRARY_PATH ã«è¿½åŠ ï¼ˆé‡è¦ï¼‰
ENV LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu:$LD_LIBRARY_PATH

# Pythonãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
RUN pip install --no-cache-dir --upgrade pip setuptools wheel
RUN pip install --no-cache-dir numpy

# Pythonç”¨GDALãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’æ˜ç¤ºçš„ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆgdal-configã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«åˆã‚ã›ã‚‹ï¼‰
RUN pip install --no-cache-dir gdal==$(gdal-config --version)

# ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
WORKDIR /app

# cesium-terrain-builder ã‚’ã‚¯ãƒ­ãƒ¼ãƒ³
RUN git clone https://github.com/geo-data/cesium-terrain-builder.git /app/cesium-terrain-builder

# Pythonä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ï¼ˆã‚¢ãƒ—ãƒªå´ï¼‰
COPY requirements_unstable.txt .
RUN pip install --no-cache-dir -r requirements_unstable.txt

# cesium-terrain-builder ã®ãƒ“ãƒ«ãƒ‰
RUN BUILD_LOG=/tmp/ctb_build.log && \
    echo "=== Starting CTB build at $(date) ===" | tee $BUILD_LOG && \
    cd /app/cesium-terrain-builder && \
    mkdir build && cd build && \
    cmake .. 2>&1 | tee -a $BUILD_LOG && \
    make -j"$(nproc)" 2>&1 | tee -a $BUILD_LOG && \
    make install 2>&1 | tee -a $BUILD_LOG && \
    echo "=== CTB build complete ===" | tee -a $BUILD_LOG && \
    rm -rf /tmp/ctb

# Flask ã‚¢ãƒ—ãƒªã‚’é…ç½®
COPY geoapp /app/geoapp
COPY run.py /app/run.py

ENV FLASK_APP=run.py

# Flask ã‚µãƒ¼ãƒã‚’èµ·å‹•
CMD ["flask", "run", "--host=0.0.0.0", "--port=5000"]
